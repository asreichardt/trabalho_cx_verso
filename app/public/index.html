<!DOCTYPE html>
<html>
<head>
    <title>MovieFlix Analytics</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        form { margin: 10px 0; }
        input, select, textarea { margin: 5px; padding: 8px; }
        .rating-good { color: green; font-weight: bold; }
        .rating-average { color: orange; font-weight: bold; }
        .rating-poor { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ MovieFlix Analytics</h1>
        
        <div class="section">
            <h2>Cadastrar Novo Filme</h2>
            <form id="movieForm">
                <input type="text" name="title" placeholder="T√≠tulo" required>
                <input type="text" name="genre" placeholder="G√™nero" required>
                <input type="number" name="release_year" placeholder="Ano" required>
                <input type="text" name="director" placeholder="Diretor">
                <input type="text" name="country" placeholder="Pa√≠s">
                <button type="submit">Cadastrar Filme</button>
            </form>
        </div>

        <div class="section">
            <h2>Avaliar Filme</h2>
            <form id="ratingForm">
                <select name="movie_id" required>
                    <option value="">Selecione um filme</option>
                </select>
                <select name="user_id" required>
                    <option value="">Selecione um usu√°rio</option>
                </select>
                <input type="number" name="rating" min="1" max="5" placeholder="Nota (1-5)" required>
                <textarea name="comment" placeholder="Coment√°rio"></textarea>
                <button type="submit">Enviar Avalia√ß√£o</button>
            </form>
        </div>

        <div class="section">
            <h2>Cat√°logo de Filmes</h2>
            <table id="moviesTable">
                <thead>
                    <tr>
                        <th>T√≠tulo</th>
                        <th>G√™nero</th>
                        <th>Ano</th>
                        <th>Diretor</th>
                        <th>Nota M√©dia</th>
                        <th>Avalia√ß√µes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // üîß CORRE√á√ÉO: Fun√ß√£o para formatar a nota m√©dia de forma segura
        function formatRating(avgRating) {
            if (avgRating === null || avgRating === undefined || isNaN(avgRating)) {
                return 'N/A';
            }
            return Number(avgRating).toFixed(1);
        }

        // üîß CORRE√á√ÉO: Fun√ß√£o para determinar a classe CSS da nota
        function getRatingClass(avgRating) {
            if (avgRating === null || avgRating === undefined || isNaN(avgRating)) {
                return '';
            }
            const rating = Number(avgRating);
            if (rating >= 4) return 'rating-good';
            if (rating >= 3) return 'rating-average';
            return 'rating-poor';
        }

        // Carregar dados
        async function loadData() {
            try {
                const [moviesResponse, usersResponse] = await Promise.all([
                    fetch('/api/movies').then(r => r.json()),
                    fetch('/api/users').then(r => r.json())
                ]);

                // üîß CORRE√á√ÉO: Garantir que movies √© um array
                const movies = Array.isArray(moviesResponse) ? moviesResponse : [];
                const users = Array.isArray(usersResponse) ? usersResponse : [];

                console.log('üìä Dados carregados:', { movies: movies.length, users: users.length });

                // Preencher tabela de filmes - CORRE√á√ÉO APPLICADA
                const tbody = document.querySelector('#moviesTable tbody');
                tbody.innerHTML = movies.map(movie => `
                    <tr>
                        <td>${movie.title || 'N/A'}</td>
                        <td>${movie.genre || 'N/A'}</td>
                        <td>${movie.release_year || 'N/A'}</td>
                        <td>${movie.director || 'N/A'}</td>
                        <td class="${getRatingClass(movie.avg_rating)}">
                            ${formatRating(movie.avg_rating)}
                        </td>
                        <td>${movie.rating_count || 0}</td>
                    </tr>
                `).join('');

                // Preencher selects - COM VALIDA√á√ÉO
                const movieSelect = document.querySelector('#ratingForm select[name="movie_id"]');
                const userSelect = document.querySelector('#ratingForm select[name="user_id"]');
                
                if (movieSelect) {
                    movieSelect.innerHTML = '<option value="">Selecione um filme</option>' +
                        movies.map(m => `<option value="${m.id}">${m.title}</option>`).join('');
                }
                
                if (userSelect) {
                    userSelect.innerHTML = '<option value="">Selecione um usu√°rio</option>' +
                        users.map(u => `<option value="${u.id}">${u.name} (${u.country})</option>`).join('');
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                // Mostrar mensagem de erro para o usu√°rio
                const tbody = document.querySelector('#moviesTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" style="color: red; text-align: center;">Erro ao carregar dados. Tente recarregar a p√°gina.</td></tr>';
                }
            }
        }

        // üîß CORRE√á√ÉO: Melhor tratamento de erros nos formul√°rios
        async function handleFormSubmit(e, url, successMessage) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                alert(successMessage || 'Opera√ß√£o realizada com sucesso!');
                e.target.reset();
                loadData(); // Recarregar dados
                
            } catch (error) {
                console.error('‚ùå Erro no formul√°rio:', error);
                alert('Erro ao processar a solicita√ß√£o. Tente novamente.');
            }
        }

        // Formul√°rio de filme
        document.getElementById('movieForm').addEventListener('submit', (e) => {
            handleFormSubmit(e, '/api/movies', 'Filme cadastrado com sucesso!');
        });

        // Formul√°rio de avalia√ß√£o
        document.getElementById('ratingForm').addEventListener('submit', (e) => {
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.rating = parseInt(data.rating);
            data.movie_id = parseInt(data.movie_id);
            data.user_id = parseInt(data.user_id);
            
            handleFormSubmit(e, '/api/ratings', 'Avalia√ß√£o registrada com sucesso!');
        });

        // üîß CORRE√á√ÉO: Recarregar dados quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina carregada, iniciando MovieFlix Analytics...');
            loadData();
            
            // Recarregar dados a cada 30 segundos (opcional)
            // setInterval(loadData, 30000);
        });

        // üîß CORRE√á√ÉO: Adicionar bot√£o de recarregar manual
        const reloadButton = document.createElement('button');
        reloadButton.textContent = 'üîÑ Recarregar Dados';
        reloadButton.style.margin = '10px';
        reloadButton.style.padding = '10px';
        reloadButton.addEventListener('click', loadData);
        
        // Inserir bot√£o antes da tabela
        const moviesSection = document.querySelector('.section h2');
        if (moviesSection) {
            moviesSection.parentNode.insertBefore(reloadButton, moviesSection.nextSibling);
        }

    </script>
</body>
</html>